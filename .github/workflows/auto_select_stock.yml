name: Auto Select Stock

on:
  schedule:
    # 每天收盘后执行，例如北京时间 15:30 后（UTC 7:30）
    - cron: "30 7 * * 1-5"
  workflow_dispatch:  # 支持手动触发

jobs:
  run_auto_select:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout 仓库
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. 设置 Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. 下载并解析通达信盘后数据
      - name: Download & parse TDX data
        run: |
          python - <<'EOF'
import pickle
from tdx_data_downloader import fetch_and_parse_tdx

all_stock_data = fetch_and_parse_tdx()
with open('tdx_all_stock_data.pkl', 'wb') as f:
    pickle.dump(all_stock_data, f)

print(f'Total stocks fetched: {len(all_stock_data)}')
EOF

      # 5. 运行选股脚本
      - name: Run auto select stock
        run: python auto_select_stock.py

      # 6. 上传选股结果
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: selected_stocks_results
          path: |
            selected_stock_count.png
            selected_stocks.csv
            tdx_all_stock_data.pkl
